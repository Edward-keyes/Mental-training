# 脑力训练大师 - 功能设计文档

**文档版本**: v1.0  
**作者**: Manus AI  
**日期**: 2025年1月5日  
**项目仓库**: [Edward-keyes/Mental-training](https://github.com/Edward-keyes/Mental-training)

---

## 目录

1. [每日挑战模式设计](#一每日挑战模式设计)
   - 1.1 功能概述
   - 1.2 数据结构设计
   - 1.3 核心算法
   - 1.4 API接口设计
   - 1.5 业务流程
2. [自适应训练系统分析](#二自适应训练系统分析)
   - 2.1 系统架构
   - 2.2 核心算法实现
   - 2.3 优化建议
3. [附录](#三附录)

---

## 一、每日挑战模式设计

### 1.1 功能概述

每日挑战模式是脑力训练大师APP的核心玩法之一，旨在通过每日固定的综合训练组合，帮助用户建立持续训练的习惯。该模式从7个训练模块中随机抽取3个组成当日挑战，所有用户在同一天看到相同的挑战组合，增强了社交可比性和竞技性。

**核心特性**：

| 特性 | 描述 |
|------|------|
| 每日随机组合 | 基于日期种子的伪随机算法，确保同一天全球用户挑战相同 |
| 三阶段流程 | 介绍页 → 挑战进行 → 结果展示 |
| 进度持久化 | 支持中断恢复，用户可随时继续未完成的挑战 |
| 奖励机制 | 1.5倍得分加成、额外经验值、连续天数追踪 |
| 时间预估 | 根据模块组合动态计算预计完成时间 |

### 1.2 数据结构设计

#### 1.2.1 训练模块定义

```typescript
interface TrainingModule {
  id: string;           // 模块唯一标识符
  name: string;         // 模块名称（中文）
  icon: string;         // 图标（Emoji）
  path: string;         // 路由路径
  color: string;        // 渐变色类名
  description: string;  // 模块描述
  skills: string[];     // 训练技能标签
  estimatedTime: number; // 预计时间（分钟）
}
```

**训练模块配置表**：

| 模块ID | 名称 | 预计时间 | 训练技能 |
|--------|------|----------|----------|
| schulte | 舒尔特表 | 3分钟 | 视觉搜索、注意力广度 |
| stroop | STOP训练 | 2分钟 | 认知控制、反应抑制 |
| sequence | 序列工作记忆 | 4分钟 | 工作记忆、信息编码 |
| auditory | 听觉选择性注意 | 3分钟 | 听觉注意、抗干扰 |
| mirror | 双侧肢体协调 | 3分钟 | 肢体协调、空间感知 |
| logic | 规则导向分类 | 4分钟 | 逻辑推理、规则学习 |
| scene | 情景联想记忆 | 5分钟 | 长期记忆、语义整合 |

#### 1.2.2 挑战进度数据结构

```typescript
interface ChallengeProgress {
  date: string;              // 挑战日期 (YYYY-MM-DD)
  completedModules: string[]; // 已完成模块ID列表
  scores: {                  // 各模块得分
    [moduleId: string]: number;
  };
  totalScore: number;        // 总分
  completed: boolean;        // 是否完成全部挑战
  startTime?: number;        // 开始时间戳
  endTime?: number;          // 结束时间戳
}
```

#### 1.2.3 训练记录数据结构

```typescript
interface TrainingRecord {
  id: string;           // 记录唯一ID
  trainingType: string; // 训练类型
  score: number;        // 得分 (0-100)
  accuracy: number;     // 准确率 (0-100)
  duration: number;     // 时长（秒）
  difficulty: number;   // 难度等级 (1-5)
  timestamp: number;    // 时间戳
}
```

### 1.3 核心算法

#### 1.3.1 日期种子生成算法

为确保同一天所有用户看到相同的挑战组合，系统采用基于日期的种子生成算法：

```typescript
function getDailySeed(): number {
  const today = new Date();
  return today.getFullYear() * 10000 
       + (today.getMonth() + 1) * 100 
       + today.getDate();
}
// 示例：2025年1月5日 → 20250105
```

**算法特点**：
- 种子值唯一对应每一天，确保全球一致性
- 数值范围在 `10000101` 到 `99991231` 之间，覆盖所有有效日期
- 无需服务端参与，纯客户端计算

#### 1.3.2 伪随机数生成器

采用线性同余生成器（Linear Congruential Generator, LCG）实现可复现的随机序列：

```typescript
function seededRandom(seed: number): () => number {
  return function() {
    seed = (seed * 9301 + 49297) % 233280;
    return seed / 233280;
  };
}
```

**参数说明**：

| 参数 | 值 | 说明 |
|------|-----|------|
| 乘数 (a) | 9301 | 线性同余乘数 |
| 增量 (c) | 49297 | 线性同余增量 |
| 模数 (m) | 233280 | 周期长度 |

该算法基于经典的LCG公式：`X_{n+1} = (aX_n + c) mod m`，具有良好的统计特性和足够的周期长度。

#### 1.3.3 模块选择算法

```typescript
function getDailyChallenges(): TrainingModule[] {
  const seed = getDailySeed();
  const random = seededRandom(seed);
  
  // Fisher-Yates 洗牌变体
  const shuffled = [...trainingModules].sort(() => random() - 0.5);
  return shuffled.slice(0, 3);
}
```

**算法流程**：
1. 获取当日种子值
2. 初始化伪随机数生成器
3. 使用随机比较函数对模块数组排序
4. 取前3个模块作为当日挑战

#### 1.3.4 连续天数计算算法

```typescript
function getStreakDays(): number {
  const history = localStorage.getItem('dailyChallengeHistory');
  if (!history) return challengeProgress.completed ? 1 : 0;
  
  const dates = JSON.parse(history) as string[];
  let streak = 0;
  const today = new Date();
  
  for (let i = 0; i < 365; i++) {
    const checkDate = new Date(today);
    checkDate.setDate(checkDate.getDate() - i);
    const dateStr = formatDate(checkDate);
    
    if (dates.includes(dateStr)) {
      streak++;
    } else if (i > 0) {
      break; // 连续中断
    }
  }
  
  return streak;
}
```

### 1.4 API接口设计

由于当前版本为纯前端实现，以下为推荐的后端API接口设计，供未来升级参考：

#### 1.4.1 获取每日挑战

```
GET /api/daily-challenge
```

**响应示例**：
```json
{
  "date": "2025-01-05",
  "modules": [
    {
      "id": "schulte",
      "name": "舒尔特表",
      "estimatedTime": 3,
      "order": 1
    },
    {
      "id": "mirror",
      "name": "双侧肢体协调",
      "estimatedTime": 3,
      "order": 2
    },
    {
      "id": "scene",
      "name": "情景联想记忆",
      "estimatedTime": 5,
      "order": 3
    }
  ],
  "totalEstimatedTime": 11,
  "rewards": {
    "bonusMultiplier": 1.5,
    "bonusExperience": 50
  }
}
```

#### 1.4.2 提交挑战结果

```
POST /api/daily-challenge/submit
```

**请求体**：
```json
{
  "date": "2025-01-05",
  "results": [
    { "moduleId": "schulte", "score": 87, "duration": 180 },
    { "moduleId": "mirror", "score": 58, "duration": 195 },
    { "moduleId": "scene", "score": 83, "duration": 320 }
  ],
  "totalTime": 695
}
```

**响应示例**：
```json
{
  "success": true,
  "totalScore": 342,
  "bonusApplied": true,
  "experienceGained": 278,
  "newStreak": 5,
  "rank": 156,
  "percentile": 85.3
}
```

#### 1.4.3 获取排行榜

```
GET /api/daily-challenge/leaderboard?date=2025-01-05&limit=100
```

**响应示例**：
```json
{
  "date": "2025-01-05",
  "leaderboard": [
    { "rank": 1, "userId": "u123", "nickname": "脑力王者", "score": 450, "time": 520 },
    { "rank": 2, "userId": "u456", "nickname": "记忆达人", "score": 438, "time": 545 }
  ],
  "totalParticipants": 1823
}
```

### 1.5 业务流程

```
┌─────────────────────────────────────────────────────────────────┐
│                        每日挑战流程图                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│   ┌─────────┐    ┌─────────────┐    ┌─────────────────────┐    │
│   │  进入   │───▶│  检查进度   │───▶│  是否有未完成挑战？  │    │
│   │  页面   │    │ (localStorage)│    └──────────┬──────────┘    │
│   └─────────┘    └─────────────┘                │               │
│                                        ┌───────┴───────┐        │
│                                        ▼               ▼        │
│                                      [是]            [否]       │
│                                        │               │        │
│                                        ▼               ▼        │
│                              ┌─────────────┐  ┌─────────────┐   │
│                              │  恢复进度   │  │  显示介绍   │   │
│                              │  继续挑战   │  │  页面       │   │
│                              └──────┬──────┘  └──────┬──────┘   │
│                                     │                │          │
│                                     ▼                ▼          │
│                              ┌─────────────────────────────┐    │
│                              │      开始/继续挑战          │    │
│                              └──────────────┬──────────────┘    │
│                                             │                   │
│                                             ▼                   │
│                              ┌─────────────────────────────┐    │
│                              │    显示当前训练模块         │◀──┐│
│                              └──────────────┬──────────────┘   ││
│                                             │                  ││
│                                             ▼                  ││
│                              ┌─────────────────────────────┐   ││
│                              │    用户完成训练             │   ││
│                              └──────────────┬──────────────┘   ││
│                                             │                  ││
│                                             ▼                  ││
│                              ┌─────────────────────────────┐   ││
│                              │    记录得分，更新进度       │   ││
│                              └──────────────┬──────────────┘   ││
│                                             │                  ││
│                                             ▼                  ││
│                              ┌─────────────────────────────┐   ││
│                              │    是否完成全部3个模块？    │   ││
│                              └──────────────┬──────────────┘   ││
│                                    ┌────────┴────────┐         ││
│                                    ▼                 ▼         ││
│                                  [否]              [是]        ││
│                                    │                 │         ││
│                                    └─────────────────┼─────────┘│
│                                                      │          │
│                                                      ▼          │
│                              ┌─────────────────────────────┐    │
│                              │    显示结果页面             │    │
│                              │  - 总分（含1.5x加成）       │    │
│                              │  - 各模块得分               │    │
│                              │  - 获得奖励                 │    │
│                              │  - 连续挑战天数             │    │
│                              └─────────────────────────────┘    │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 二、自适应训练系统分析

### 2.1 系统架构

自适应训练系统是脑力训练大师的核心智能模块，负责根据用户的历史表现动态调整训练难度和推荐训练内容，实现"跳一跳能够得着"的最佳学习区间（Zone of Proximal Development）。

**系统组件**：

```
┌─────────────────────────────────────────────────────────────────┐
│                      自适应训练系统架构                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────────────┐ │
│  │  用户数据   │───▶│  分析引擎   │───▶│  推荐/难度输出      │ │
│  │  存储层    │    │             │    │                     │ │
│  │            │    │ - 趋势分析  │    │ - 难度推荐          │ │
│  │ - 训练记录 │    │ - 能力评估  │    │ - 训练推荐          │ │
│  │ - 能力分数 │    │ - 优先级    │    │ - 每日计划          │ │
│  │ - 成就数据 │    │   计算      │    │ - 能力分析报告      │ │
│  └─────────────┘    └─────────────┘    └─────────────────────┘ │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 2.2 核心算法实现

#### 2.2.1 难度推荐算法

难度推荐算法基于用户最近5次训练的平均分数和表现趋势，输出1-5级的难度建议。

**算法实现**：

```typescript
function recommendDifficulty(trainingType: TrainingType): DifficultyLevel {
  const records = getRecentRecords(trainingType, 5);
  const avgScore = calculateAverageScore(records);
  const trend = calculateTrend(records);
  
  // 基于平均分数确定基础难度
  let baseDifficulty: DifficultyLevel;
  if (avgScore < 40) baseDifficulty = 1;
  else if (avgScore < 55) baseDifficulty = 2;
  else if (avgScore < 70) baseDifficulty = 3;
  else if (avgScore < 85) baseDifficulty = 4;
  else baseDifficulty = 5;
  
  // 根据趋势调整
  if (trend === "improving" && baseDifficulty < 5) {
    baseDifficulty = (baseDifficulty + 1) as DifficultyLevel;
  } else if (trend === "declining" && baseDifficulty > 1) {
    baseDifficulty = (baseDifficulty - 1) as DifficultyLevel;
  }
  
  return baseDifficulty;
}
```

**难度映射表**：

| 平均分数范围 | 基础难度 | 趋势调整 |
|-------------|---------|---------|
| 0-39 | 1级（入门） | 上升+1，下降不变 |
| 40-54 | 2级（简单） | 上升+1，下降-1 |
| 55-69 | 3级（中等） | 上升+1，下降-1 |
| 70-84 | 4级（困难） | 上升+1，下降-1 |
| 85-100 | 5级（专家） | 不变，下降-1 |

#### 2.2.2 趋势分析算法

趋势分析将用户最近的训练记录分为前后两半，比较平均分数变化：

```typescript
function calculateTrend(records: TrainingRecord[]): "improving" | "stable" | "declining" {
  if (records.length < 3) return "stable";
  
  const recentHalf = records.slice(-Math.ceil(records.length / 2));
  const olderHalf = records.slice(0, Math.floor(records.length / 2));
  
  const recentAvg = calculateAverageScore(recentHalf);
  const olderAvg = calculateAverageScore(olderHalf);
  
  const diff = recentAvg - olderAvg;
  
  if (diff > 5) return "improving";   // 进步
  if (diff < -5) return "declining";  // 退步
  return "stable";                     // 稳定
}
```

**趋势判定阈值**：

| 分数差值 | 趋势判定 |
|---------|---------|
| > +5 | 进步中 (improving) |
| -5 ~ +5 | 稳定 (stable) |
| < -5 | 退步中 (declining) |

#### 2.2.3 训练优先级计算

系统综合考虑能力分数、训练间隔等因素，为每个训练模块计算优先级分数：

```typescript
function calculatePriority(
  abilityScore: number,
  lastTrainingDate: Date | null
): number {
  let priority = 50; // 基础分
  
  // 能力分数越低，优先级越高（权重30%）
  priority += (100 - abilityScore) * 0.3;
  
  // 训练间隔越长，优先级越高
  if (lastTrainingDate) {
    const daysSinceLastTraining = 
      (Date.now() - lastTrainingDate.getTime()) / (1000 * 60 * 60 * 24);
    priority += Math.min(daysSinceLastTraining * 5, 20); // 最高+20
  } else {
    priority += 25; // 从未训练过，高优先级
  }
  
  return priority;
}
```

**优先级计算公式**：

```
Priority = 50 + (100 - AbilityScore) × 0.3 + min(DaysSinceLastTraining × 5, 20)
```

**优先级影响因素**：

| 因素 | 权重/上限 | 说明 |
|------|----------|------|
| 基础分 | 50 | 所有训练的起始优先级 |
| 能力分数 | 0-30 | 能力越弱，优先级越高 |
| 训练间隔 | 0-20 | 间隔越长，优先级越高 |
| 从未训练 | +25 | 新模块额外加分 |

#### 2.2.4 能力分析算法

系统为7项认知能力生成详细分析报告：

```typescript
interface AbilityAnalysis {
  ability: keyof AbilityScores;
  name: string;
  score: number;
  trend: "improving" | "stable" | "declining";
  recentChange: number;
  recommendation: string;
}
```

**能力建议生成规则**：

| 能力分数 | 建议内容 |
|---------|---------|
| < 40 | 建议增加训练频率，每天至少练习一次 |
| 40-59 | 保持当前训练节奏，逐步提升难度 |
| 60-79 | 表现良好，可以尝试更高难度挑战 |
| ≥ 80 | 优秀！保持训练以维持高水平 |

### 2.3 优化建议

基于对当前自适应训练系统的分析，以下是进一步优化的建议：

#### 2.3.1 算法层面优化

**1. 引入指数加权移动平均（EWMA）**

当前算法对所有历史记录赋予相同权重，建议引入EWMA使近期表现具有更高权重：

```typescript
function calculateEWMA(records: TrainingRecord[], alpha: number = 0.3): number {
  if (records.length === 0) return 50;
  
  let ewma = records[0].score;
  for (let i = 1; i < records.length; i++) {
    ewma = alpha * records[i].score + (1 - alpha) * ewma;
  }
  return ewma;
}
```

**2. 实现多因素难度调整**

当前仅考虑分数和趋势，建议增加以下因素：

| 新增因素 | 调整逻辑 |
|---------|---------|
| 准确率 | 准确率>90%时难度+1 |
| 完成时间 | 时间显著低于平均时难度+1 |
| 连续正确次数 | 连续10次正确时难度+1 |
| 用户主动选择 | 允许用户手动调整±1级 |

**3. 引入贝叶斯能力评估**

采用Item Response Theory (IRT)模型更精确地评估用户能力：

```
P(正确|能力θ, 难度b) = 1 / (1 + e^(-(θ-b)))
```

#### 2.3.2 数据层面优化

**1. 增加训练元数据**

```typescript
interface EnhancedTrainingRecord extends TrainingRecord {
  // 新增字段
  responseTimeDistribution: number[];  // 每题反应时间
  errorPatterns: string[];             // 错误类型分析
  focusScore: number;                  // 专注度评分
  deviceType: string;                  // 设备类型
  timeOfDay: number;                   // 训练时段
}
```

**2. 实现跨模块能力关联**

建立训练模块与多项能力的关联矩阵：

| 训练模块 | 注意力 | 记忆力 | 反应速度 | 逻辑推理 | 协调能力 | 抑制控制 |
|---------|-------|-------|---------|---------|---------|---------|
| 舒尔特表 | 0.8 | 0.2 | 0.5 | 0.1 | 0.1 | 0.3 |
| STOP训练 | 0.4 | 0.1 | 0.6 | 0.2 | 0.1 | 0.9 |
| 序列记忆 | 0.3 | 0.9 | 0.2 | 0.3 | 0.1 | 0.2 |
| 听觉注意 | 0.7 | 0.3 | 0.4 | 0.1 | 0.1 | 0.5 |
| 肢体协调 | 0.2 | 0.2 | 0.5 | 0.1 | 0.9 | 0.3 |
| 逻辑分类 | 0.3 | 0.4 | 0.2 | 0.9 | 0.1 | 0.4 |
| 情景联想 | 0.2 | 0.8 | 0.1 | 0.3 | 0.1 | 0.1 |

#### 2.3.3 用户体验优化

**1. 实现渐进式难度调整**

避免难度跳跃过大，建议实现平滑过渡：

```typescript
function smoothDifficultyTransition(
  currentDifficulty: number,
  targetDifficulty: number,
  maxStep: number = 0.5
): number {
  const diff = targetDifficulty - currentDifficulty;
  const step = Math.sign(diff) * Math.min(Math.abs(diff), maxStep);
  return currentDifficulty + step;
}
```

**2. 添加难度预览和确认**

在开始训练前显示推荐难度，允许用户确认或调整：

```
┌─────────────────────────────────────┐
│  系统推荐难度: ★★★☆☆ (中等)        │
│                                     │
│  基于您最近5次训练:                  │
│  - 平均分: 68分                     │
│  - 趋势: 稳步提升 ↑                 │
│                                     │
│  [降低难度] [开始训练] [提高难度]    │
└─────────────────────────────────────┘
```

**3. 实现智能训练计划生成**

根据用户目标和时间安排，自动生成个性化训练计划：

```typescript
interface TrainingPlan {
  weeklyGoal: {
    totalMinutes: number;
    focusAreas: string[];
  };
  dailySchedule: {
    day: string;
    trainings: {
      type: TrainingType;
      difficulty: DifficultyLevel;
      duration: number;
    }[];
  }[];
}
```

#### 2.3.4 技术架构优化

**1. 迁移到服务端计算**

当前自适应算法在客户端执行，建议迁移到服务端以支持：
- 更复杂的机器学习模型
- 跨设备数据同步
- A/B测试不同算法版本
- 防止数据篡改

**2. 引入实时分析管道**

```
用户行为 → Kafka → Flink实时处理 → 特征存储 → 推荐服务 → 客户端
```

**3. 实现离线能力评估**

定期运行批处理任务，使用更复杂的模型评估用户能力：

```python
# 伪代码示例
def batch_ability_assessment(user_id):
    records = fetch_all_records(user_id)
    
    # 使用IRT模型评估
    ability_theta = irt_model.estimate_ability(records)
    
    # 使用聚类分析识别用户类型
    user_cluster = clustering_model.predict(records)
    
    # 生成个性化建议
    recommendations = generate_recommendations(ability_theta, user_cluster)
    
    return {
        'ability_scores': ability_theta,
        'user_type': user_cluster,
        'recommendations': recommendations
    }
```

---

## 三、附录

### 3.1 数据结构完整定义

```typescript
// 能力评估数据
interface AbilityScores {
  attention: number;      // 注意力 (0-100)
  memory: number;         // 记忆力 (0-100)
  reaction: number;       // 反应速度 (0-100)
  logic: number;          // 逻辑推理 (0-100)
  coordination: number;   // 协调能力 (0-100)
  inhibition: number;     // 抑制控制 (0-100)
  creativity: number;     // 创造力 (0-100)
}

// 用户数据
interface UserData {
  totalTrainingTime: number;  // 总训练时间（秒）
  totalSessions: number;      // 总训练次数
  currentStreak: number;      // 连续训练天数
  longestStreak: number;      // 最长连续天数
  lastTrainingDate: string;   // 最后训练日期
  level: number;              // 用户等级
  experience: number;         // 经验值
  abilityScores: AbilityScores;
  trainingHistory: TrainingRecord[];
  achievements: Achievement[];
  dailyGoal: number;          // 每日目标（分钟）
  dailyProgress: number;      // 今日进度（分钟）
}

// 成就
interface Achievement {
  id: string;
  name: string;
  description: string;
  icon: string;
  unlockedAt?: number;
  progress: number;
  target: number;
}
```

### 3.2 经验值与等级计算

```typescript
// 经验值计算公式
const expGained = Math.floor(
  score * accuracy / 100 * (1 + difficulty * 0.1)
);

// 等级计算（每级所需经验递增）
let level = 1;
let remainingExp = totalExp;
while (remainingExp >= level * 100) {
  remainingExp -= level * 100;
  level++;
}
```

**等级经验需求表**：

| 等级 | 所需经验 | 累计经验 |
|-----|---------|---------|
| 1→2 | 100 | 100 |
| 2→3 | 200 | 300 |
| 3→4 | 300 | 600 |
| 4→5 | 400 | 1000 |
| ... | ... | ... |
| 9→10 | 900 | 4500 |

### 3.3 文件结构

```
client/src/
├── hooks/
│   ├── useUserData.ts        # 用户数据管理
│   └── useAdaptiveSystem.ts  # 自适应训练系统
├── pages/
│   ├── DailyChallenge.tsx    # 每日挑战页面
│   ├── Dashboard.tsx         # 数据面板
│   └── training/             # 训练模块
│       ├── SchulteTable.tsx
│       ├── StroopTest.tsx
│       └── ...
└── components/
    └── Layout.tsx            # 布局组件
```

---

**文档结束**

*本文档基于 [Mental-training](https://github.com/Edward-keyes/Mental-training) 项目代码分析生成，如有疑问请参考源代码。*
